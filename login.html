<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBZU3oUaCNjMVVTTwXBqaUH0XYY5M9K7z0",
            authDomain: "avalis-9c595.firebaseapp.com",
            databaseURL: "https://avalis-9c595-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "avalis-9c595",
            storageBucket: "avalis-9c595.appspot.com",
            messagingSenderId: "1014604630131",
            appId: "1:1014604630131:web:b4b9fc13163834ff7d4206",
            measurementId: "G-Q7D9PP4KFH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        function loginUser(event) {
            event.preventDefault();

            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            console.log("üîë Attempting login with:", email);

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log("‚úÖ Login successful:", user);

                    // Get user's role from database
                    const userRef = ref(database, "users/" + user.uid);
                    get(userRef).then((snapshot) => {
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            console.log("üìå User role:", userData.role);

                            // Store role in localStorage
                            localStorage.setItem("userRole", userData.role);

                            alert("Login successful! Redirecting...");

                            // Redirect users based on their role
                            if (userData.role === "dungeon-master") {
                                window.location.href = "dm-dashboard.html"; // Redirect DMs to their dashboard
                            } else {
                                window.location.href = "index.html"; // Redirect Players to homepage
                            }
                        } else {
                            console.error("‚ùå No user data found in database!");
                            alert("Login failed: No user data found.");
                        }
                    }).catch((error) => {
                        console.error("‚ùå Error retrieving user data:", error);
                        alert("Error retrieving user data.");
                    });

                })
                .catch((error) => {
                    console.error("‚ùå Login failed:", error);
                    alert("Login failed: " + error.message);
                });
        }

        document.addEventListener("DOMContentLoaded", () => {
            console.log("‚úÖ DOM Loaded. Adding event listener.");
            const form = document.getElementById("login-form");
            if (form) {
                form.addEventListener("submit", loginUser);
                console.log("‚úÖ Login form event listener attached.");
            } else {
                console.error("‚ùå Login form not found.");
            }
        });
    </script>
</head>
<body>
    <!-- Header -->
    <div id="header-container"></div>

    <h2>Login</h2>
    <form id="login-form">
        <label for="email">Email:</label>
        <input type="email" id="email" required>

        <label for="password">Password:</label>
        <input type="password" id="password" required>

        <button type="submit">Login</button>
    </form>

    <script>
        // Load the header dynamically
        fetch("header.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("header-container").innerHTML = data;
            });
    </script>
</body>
</html>
